---
import AppLayout from "../../layouts/app/AppLayout.astro";
import type { BentoBetterAuthUser } from "../../library/auth";
import ProfileEditor from "../../components/profile/ProfileEditor.svelte";
import { fetchUserProfile } from "../../library/server/bentoApi";
import type { ProfileDto } from "../../library/types/interfaces";

const user = Astro.locals.user as BentoBetterAuthUser | null;

const title = `Edit Bento Profile ${user?.name ? `- ${user.name}` : ""}`;
const description = "Customize your Bento profile";

const username = user?.discordUsername || user?.name || "User";
const discriminator = user?.discordDiscriminator;
const discordTag = discriminator && discriminator !== "0" ? `${username}#${discriminator}` : username;

let initialProfile: ProfileDto | null = null;
if (user) {
  try {
    initialProfile = await fetchUserProfile(user.discordId);
  } catch (e) {
    // swallow error; component will fall back to defaults
    initialProfile = null;
  }
}
---

<AppLayout title={title} description={description}>
  <div class="container mx-auto px-4 py-8">
    <div class="mb-6 flex items-center gap-4">
      <a href="/profile" class="text-sm text-zinc-600 dark:text-zinc-400 hover:underline">‚Üê Back to Profile</a>
      <h1 class="text-2xl font-bold">Edit Bento profile</h1>
    </div>

    {/** Not signed in **/}
    {!user && (
      <div class="text-center py-10 bg-zinc-100 dark:bg-zinc-900 rounded-lg shadow">
        <p class="text-gray-700 dark:text-gray-300 mb-4">You are not signed in.</p>
        <a href="/profile" class="underline">Go to Profile</a>
      </div>
    )}

    {/** Signed in **/}
    {user && (
      <>
        <link href='https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700&display=swap' rel='stylesheet' />
        <ProfileEditor client:only="svelte" userId={user.discordId} username={username} discriminator={user.discordDiscriminator} avatarUrl={user?.image} initialProfile={initialProfile} />
      </>
    )}
  </div>
</AppLayout>
