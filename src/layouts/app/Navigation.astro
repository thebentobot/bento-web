---
import MobileMenu from "../../components/app/MobileMenu.svelte";
import { classNames } from "../../library/utils";
import NavBlurHandler from "./NavBlurHandler.svelte";
import UserMenu from "../../components/app/UserMenu.svelte";
import { Icon } from "astro-icon/components";
import type { BentoBetterAuthUser } from "../../library/auth";

let currentPath = Astro.url.pathname;
const user = Astro.locals.user as BentoBetterAuthUser;

const navigationRoutes = [
    { name: "About", route: "/about" },
    { name: "Support", route: "/support" },
    { name: "Leaderboard", route: "/leaderboard" },
];

const isCurrentRoute = (route: string): boolean => {
    if (!currentPath) return false;
    return route === "/"
        ? currentPath === "/"
        : currentPath === route || currentPath.startsWith(route + "/");
};

const stickyNavHeaderClass = classNames(
    "flex flex-col items-center w-full sticky top-0 z-20 sm:bg-inherit/30",
    // eslint-disable-next-line no-undef
    typeof window !== "undefined" && document.body.classList.contains("mobile-menu-open")
        ? ""
        : "backdrop-blur-xs"
);
---

<NavBlurHandler client:only="svelte" />
<header id="stickyNav" class={stickyNavHeaderClass}>
    <nav class="grid grid-cols-3 items-center w-full max-w-7xl px-4 sm:px-8 py-4">
        <!-- Left section - Mobile Menu -->
        <div class="sm:hidden flex justify-start w-10">
            <MobileMenu
                navigationRoutes={navigationRoutes}
                currentPath={currentPath}
                user={user}
                client:only="svelte"
            >
                <span
                    slot="fallback"
                    class="md:hidden flex items-center justify-center p-2 rounded-lg hover:bg-yellow-400 dark:hover:bg-yellow-500 transition-colors duration-300 opacity-50 cursor-not-allowed"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 text-zinc-800 dark:text-zinc-200"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </span>
            </MobileMenu>
        </div>

        <!-- Left section - Desktop Navigation -->
        <div class="hidden sm:flex ml-0 items-center col-span-2">
            <a href="/" data-astro-prefetch class="rounded-full mr-6">
                <span class="sr-only">Home</span>
                <div
                    class="h-14 w-14 rounded-full hover:bg-yellow-400 dark:hover:bg-yellow-500 transition-colors duration-300 flex items-center justify-center"
                >
                    <img src="/29.webp" alt="Bento Logo" class="h-12 w-12 rounded-full" />
                </div>
            </a>
            <div class="gap-x-4 flex">
                {
                    navigationRoutes.map((route) => (
                        <>
                            <span class="sr-only">{route.name}</span>
                            <a
                                href={route.route}
                                data-astro-prefetch
                                class={`px-3 py-2 rounded-lg hover:bg-yellow-400 hover:text-black dark:hover:bg-yellow-500 dark:hover:text-black transition-colors duration-300 ${
                                    isCurrentRoute(route.route)
                                        ? "font-semibold bg-yellow-400 text-black dark:bg-yellow-500 dark:text-black"
                                        : "font-semibold text-black dark:text-white"
                                }`}
                            >
                                {route.name}
                            </a>
                        </>
                    ))
                }
            </div>
        </div>

        <!-- Center section - Mobile Logo -->
        <div class="sm:hidden flex justify-center">
            <a href="/" data-astro-prefetch class="rounded-full">
                <span class="sr-only">Home</span>
                <div
                    class="gap-x-2 rounded-md p-2 hover:bg-yellow-400 dark:hover:bg-yellow-500 dark:hover:text-black transition-colors duration-300 flex items-center justify-center"
                >
                    <span class="font-semibold">Bento</span>
                    <img src="/29.webp" alt="Logo" class="h-6 w-6 rounded-full" />
                </div>
            </a>
        </div>

        <!-- Right section - User Menu (Avatar + Theme/Profile/Login/Logout) -->
        <div class="flex justify-end items-center">
            <UserMenu user={user} client:only="svelte">
                <span
                    slot="fallback"
                    class="flex items-center justify-center p-2 rounded-lg hover:bg-yellow-400 dark:hover:bg-yellow-500 transition-colors duration-300 opacity-50 cursor-not-allowed"
                >
                    {
                        user ? (
                            <span
                                class="h-8 w-8 rounded-full bg-zinc-200 dark:bg-zinc-700 animate-pulse"
                                aria-hidden="true"
                            />
                        ) : (
                            <Icon name="user" class="h-6 w-6 text-zinc-800 dark:text-zinc-200" />
                        )
                    }
                </span>
            </UserMenu>
        </div>
    </nav>
</header>

<script>
    const nav = document.getElementById("stickyNav");

    const updateBlur = () => {
        if (document.body.classList.contains("mobile-menu-open")) {
            nav?.classList.remove("backdrop-blur-xs");
        } else {
            nav?.classList.add("backdrop-blur-xs");
        }
    };

    window.addEventListener("scroll", () => {
        if (window.scrollY > 1) {
            nav?.classList.add(
                "border-b",
                "dark:border-zinc-900/25",
                "border-zinc-50/25",
                "shadow-xs"
            );
        } else {
            nav?.classList.remove(
                "border-b",
                "dark:border-zinc-900/25",
                "border-zinc-50/25",
                "shadow-xs"
            );
        }
    });

    const observer = new MutationObserver(updateBlur);
    observer.observe(document.body, { attributes: true, attributeFilter: ["class"] });

    updateBlur();
</script>
